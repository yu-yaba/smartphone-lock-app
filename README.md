# スマホ依存防止アプリ 要件定義書（v1.3）

---

## 1. 概要
本アプリは、スマホ依存症の克服を目的とした **「完全ロック型スマホ制御アプリ」** である。  
ユーザーが設定した一定時間、スマートフォンの操作を完全に制限し、
通話およびSMSなどの最低限の機能以外を使用できなくする。

**2025/11/03 更新:** Lock Task Mode 依存のアプローチは撤廃し、今後は「オーバーレイ + 使用状況アクセス + 通知アクセス」を組み合わせたソフトロック方式を目指す。  
現時点では UI と時間管理のみを提供し、権限導入はプレースホルダーとして表示している。

---

## 2. デザイン原則
- **シンプル**：迷いゼロ、最短で「ロック」できる導線。
- **集中維持**：ロック中は視覚的ノイズを排除し、残り時間のみを明快に表示。
- **正当性**：Google Play ポリシーに沿った権限利用（オーバーレイ / 使用状況 / 通知アクセス）を前提。Lock Task Mode は使用しない。
- **拡張性**：将来の「履歴」「レポート」「サブスク」追加を前提に情報設計。

---

## 3. システム構成

| コンポーネント | 技術スタック |
|----------------|--------------|
| フロントエンド | Kotlin（Jetpack Compose, Material3） |
| バックエンド   | Supabase（Auth, Realtime, Storage） |
| 認証方式       | Supabase Auth（Emailリンク / Google） |
| タイマー制御   | AlarmManager（正確なロック解除スケジュール） |
| デプロイ環境   | Google Play（β版リリース想定） |

---

## 4. UI構成とテーマ

### 4.1 画面構造（2タブ固定）
```
MainActivity
 ├─ Scaffold
 │   ├─ BottomNavigationBar（固定2タブ）
 │   │   ├─ Lock（ロック画面）
 │   │   └─ Settings（設定画面）
 │   └─ NavHost
 │       ├─ LockScreen
 │       └─ SettingsScreen
```
- フッター（BottomNavigation）に **「ロック」「設定」** を常時表示。
- アプリ起動時は **権限未許可なら権限導入画面**、許可済みなら **LockScreen** へ。

### 4.2 テーマ（黒 × 黄色）
| 要素 | 色 | 意図 |
|------|----|------|
| 背景 | 黒 `#000000` | 集中・遮断・没入 |
| アクセント | 黄色 `#FFD700` | 注意・集中・スイッチ感 |
| テキスト | 白 / 黄色 | 状態で切替（残り時間は黄色で強調） |
| ボタン | 黄色背景 + 黒文字 | 行動を強く喚起 |

---

## 5. 機能要件

### 5.1 ロック設定（LockScreen）
- **時間設定範囲**：**1〜72時間**（分単位は実装ポリシーに応じて切替可）。
- **UI**：ダイヤル（Circular / Picker）または縦ホイール。大きな「ロック開始」ボタンを下部配置。
- **ロック開始**：確定アクション後にソフトロック制御を開始し、解除時刻を AlarmManager に登録する想定。
- **ロック中UI**：画面中央に **残り時間カウントダウン** を大きく表示（毎秒更新）。
- **ロック解除**：設定時間経過で自動解除（AlarmManager）。

### 5.2 ロックモード（ソフトロック構想）
- Lock Task Mode は利用しない。
- 今後の実装で目指す制御：
  - オーバーレイ権限で常時前面にガイド画面を表示。
  - 使用状況アクセスで許可外アプリを検知し、即座にロック画面へ戻す。
  - 通知アクセスで重要外通知を抑制／記録する。
- 現段階では権限チェックはスタブで、実際の制御は未実装。

### 5.3 ロック解除
- AlarmManager を活用した自動解除ロジックは維持予定（Lock Task 依存部分は未実装）。
- 強制解除は原則提供しない想定。
- 端末再起動時の扱いなどはソフトロック方式確定後に再整理する。

### 5.4 データ記録（Supabase）
- 現時点でのサーバ保存は最小限：
  - ユーザーID（匿名ID可）
  - ロック時間設定値（例：180分）
- ロック開始・解除「時刻」はクライアントローカルで管理（オフライン優先、同期必須ではない）。

### 5.5 抜け道封鎖ポリシー（2025/11/09 追加）
- **設定アプリの強制リダイレクト**: UsageStats で `com.android.settings` や `com.android.systemui`（通知シェード／コントロールセンター）が前面に来た瞬間、Overlay を再描画すると同時に `Intent.FLAG_ACTIVITY_NEW_TASK` 付きで本アプリを最前面に呼び戻す。1 秒間隔のデバウンサーで再描画を制限しつつ、ユーザー視点では常にロック UI が復帰する体験を保つ。
- **SystemUI フォールバック監視**: 端末によっては UsageStats が `com.android.systemui` を通知しないため、`ActivityManager.runningAppProcesses` を 750ms 間隔でポーリングし SystemUI が `IMPORTANCE_FOREGROUND` に昇格した瞬間にも上記リダイレクトを実行する。コントロールセンターやクイック設定経由で設定アプリへ遷移する抜け道もこの経路で検知する。
- **Overlay / 通知権限の必須化**: 初回起動時に 3 権限のうち Overlay/通知を必須として許可が完了するまで Lock 画面へ遷移させない。ロック中に権限が外れた場合もサービス側で検知して再許可を求める。
- **再起動時の即復帰**: `RECEIVE_BOOT_COMPLETED` を受け取る Receiver で端末起動直後に `LockMonitorService`/`OverlayLockService` を再起動し、DataStore 上ロック状態なら即座にオーバーレイを再掲出する。
- **既定ダイヤラ/SMS 以外のアプリを封鎖**: `TelecomManager`/`SmsManager` から取得した端末既定の通話・メッセージアプリのみホワイトリスト化し、その他アプリはすべて Overlay 対象にすることで電話・SMS 以外の操作を完全に遮断する。

---

## 6. 権限導入フロー（Onboarding）

### 6.1 表示条件
- オーバーレイ／使用状況／通知アクセスのいずれかが未許可の場合は、アプリ起動時に権限確認画面を表示。
- すべて許可済みであれば LockScreen へ遷移。

### 6.2 フロー概要
```
起動
 ├─ 権限導入画面（3権限のステータス表示＋設定アプリへの導線ボタン）
 ├─ ユーザーが権限を付与 → アプリ復帰後に状態が更新
 └─ 完了 → LockScreen 表示
```

### 6.3 UIテキスト
- 権限ステータスを一覧表示（有効/未取得）。
- 「権限状態を再読み込み」ボタンで `LockPermissionsRepository` を更新。
- 各権限ごとに説明と設定アプリへ遷移するボタンを提供。

---

## 7. 設定画面（Settings）とログイン導線
- 設定タブに **Supabase Auth（Google / メールリンク）** の導線を設置。
- **初回体験はログイン不要**：まずはロック体験を優先。
- 未ログイン時：**「ログインしてデータを保存」** ボタンをカード表示。
- ログイン後：メールアドレス/ログアウトボタン、将来的に **サブスク・履歴・レポート** 導線を同画面に配置。

---

## 8. 非機能要件
| 項目 | 内容 |
|------|------|
| 対応OS | Android 11 以降 |
| オフライン対応 | 完全ローカルで成立（Supabase 同期は任意） |
| セキュリティ | Supabase Auth によるセキュア認証 |
| 権限設計 | オーバーレイ / 使用状況 / 通知アクセスを取得するソフトロック方式（Lock Task Mode は未使用） |
| UI設計 | Material 3 準拠、黒 × 黄色テーマ |
| テレメトリ | （任意）Sentry 等による障害監視 |

---

## 9. 法的・配布ポリシー上の考慮
- **Google Play ポリシー遵守**：Overlay / UsageStats / Notification の 3 権限のみを利用し、Accessibility API やデバイス管理特権には依存しない。Foreground Service からのバックグラウンド起動が必要となるため、通知経由でユーザーにロック継続を明示し、ポリシー上の正当な利用ケース（集中モード）として扱う。
- **データプライバシー**：収集は最小限（ユーザーID・設定値）。国外リージョン保管を明記。匿名運用を基本。

---

## 10. 将来的拡張
- **履歴/レポート**：ロック履歴、解除試行、電源再起動等のイベントログ収集と可視化。
- **通知**：開始前リマインド、終了直前の残り時間通知（Android 13+ の正確アラーム権限に対応）。
- **サブスク**：広告非表示、詳細統計、クラウドバックアップ等の解放。

---

## 11. バージョン履歴
| バージョン | 変更内容 | 日付 |
|-----------|----------|------|
| v1.1 | 初版（Lock Task Mode 概要） | 2025/10/21 |
| v1.2 | Lock Task + AlarmManager 対応、法的方針追記 | 2025/10/22 |
| **v1.3** | 2タブUI/黒×黄色テーマ/権限導入UIを公開。Lock Task Mode を撤廃しソフトロック方式への移行方針を追記 | **2025/11/03** |
