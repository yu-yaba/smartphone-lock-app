# スマホ依存防止アプリ 要件定義書（v1.3）

---

## 1. 概要
本アプリは、スマホ依存症の克服を目的とした **「完全ロック型スマホ制御アプリ」** である。  
ユーザーが設定した一定時間、スマートフォンの操作を完全に制限し、
通話およびSMSなどの最低限の機能以外を使用できなくする。

本アプリは Android の公式機能である **Lock Task Mode（全画面固定モード）** を利用し、
非公式APIやAccessibility権限を使用しない、安全で合法的な制御を実現する。

---

## 2. デザイン原則
- **シンプル**：迷いゼロ、最短で「ロック」できる導線。
- **集中維持**：ロック中は視覚的ノイズを排除し、残り時間のみを明快に表示。
- **正当性**：Android公式機能（Lock Task / AlarmManager）を前提。不要権限は使わない。
- **拡張性**：将来の「履歴」「レポート」「サブスク」追加を前提に情報設計。

---

## 3. システム構成

| コンポーネント | 技術スタック |
|----------------|--------------|
| フロントエンド | Kotlin（Jetpack Compose, Material3） |
| バックエンド   | Supabase（Auth, Realtime, Storage） |
| 認証方式       | Supabase Auth（Emailリンク / Google） |
| タイマー制御   | AlarmManager（正確なロック解除スケジュール） |
| デプロイ環境   | Google Play（β版リリース想定） |

---

## 4. UI構成とテーマ

### 4.1 画面構造（2タブ固定）
```
MainActivity
 ├─ Scaffold
 │   ├─ BottomNavigationBar（固定2タブ）
 │   │   ├─ Lock（ロック画面）
 │   │   └─ Settings（設定画面）
 │   └─ NavHost
 │       ├─ LockScreen
 │       └─ SettingsScreen
```
- フッター（BottomNavigation）に **「ロック」「設定」** を常時表示。
- アプリ起動時は **権限未許可なら権限導入画面**、許可済みなら **LockScreen** へ。

### 4.2 テーマ（黒 × 黄色）
| 要素 | 色 | 意図 |
|------|----|------|
| 背景 | 黒 `#000000` | 集中・遮断・没入 |
| アクセント | 黄色 `#FFD700` | 注意・集中・スイッチ感 |
| テキスト | 白 / 黄色 | 状態で切替（残り時間は黄色で強調） |
| ボタン | 黄色背景 + 黒文字 | 行動を強く喚起 |

---

## 5. 機能要件

### 5.1 ロック設定（LockScreen）
- **時間設定範囲**：**1〜72時間**（分単位は実装ポリシーに応じて切替可）。
- **UI**：ダイヤル（Circular / Picker）または縦ホイール。大きな「ロック開始」ボタンを下部配置。
- **ロック開始**：確定アクション後に Lock Task Mode を開始し、解除時刻を AlarmManager に登録。
- **ロック中UI**：画面中央に **残り時間カウントダウン** を大きく表示（毎秒更新）。
- **ロック解除**：設定時間経過で自動解除（AlarmManager）。

### 5.2 ロックモード（全画面固定モード）
- Android公式の **Lock Task Mode** を利用。
- ロック中は以下を維持：
  - ホームボタンでアプリが離脱しない / 画面前面の維持
  - 通知シェード等の UI から復帰してもアプリが前面（機種差は許容）
- 利用可能機能：電話・SMS のみ（端末標準の挙動に準拠）。
- **SYSTEM_ALERT_WINDOW（オーバーレイ）や Accessibility は使用しない**。

### 5.3 ロック解除
- **AlarmManager** により自動的に Lock Task Mode を終了。
- 強制解除は原則提供しない（開発者向け手段のみ例外）。
- 端末再起動時は Lock Task が解除される想定（安全設計）。

### 5.4 データ記録（Supabase）
- 現時点でのサーバ保存は最小限：
  - ユーザーID（匿名ID可）
  - ロック時間設定値（例：180分）
- ロック開始・解除「時刻」はクライアントローカルで管理（オフライン優先、同期必須ではない）。

---

## 6. 権限導入フロー（Onboarding）

### 6.1 表示条件
- **デバイス管理者権限（Device Admin/Owner）が未許可の場合：アプリ起動時に毎回表示**。
- 許可済みならスキップして **LockScreen** へ遷移。

### 6.2 フロー概要
```
起動
 ├─ 権限導入画面（説明は簡潔、ボタン：権限を有効にする）
 ├─ システム設定画面で Device Admin を有効化
 ├─ アプリに戻る → 権限状態チェック
 └─ 完了 → LockScreen 表示
```

### 6.3 UIテキスト（簡潔トーン）
- タイトル：**ロックを有効にする準備**
- 説明：**ロック機能を使うには権限を有効にしてください。**
- ボタン：**権限を有効にする**
- サブテキスト：**※いつでも設定から変更できます**

---

## 7. 設定画面（Settings）とログイン導線
- 設定タブに **Supabase Auth（Google / メールリンク）** の導線を設置。
- **初回体験はログイン不要**：まずはロック体験を優先。
- 未ログイン時：**「ログインしてデータを保存」** ボタンをカード表示。
- ログイン後：メールアドレス/ログアウトボタン、将来的に **サブスク・履歴・レポート** 導線を同画面に配置。

---

## 8. 非機能要件
| 項目 | 内容 |
|------|------|
| 対応OS | Android 11 以降 |
| オフライン対応 | 完全ローカルで成立（Supabase 同期は任意） |
| セキュリティ | Supabase Auth によるセキュア認証 |
| 権限設計 | Lock Task + AlarmManager のみ（Accessibility / Overlay 不使用） |
| UI設計 | Material 3 準拠、黒 × 黄色テーマ |
| テレメトリ | （任意）Sentry 等による障害監視 |

---

## 9. 法的・配布ポリシー上の考慮
- **Google Play ポリシー遵守**：非アクセシビリティ目的での Accessibility 利用は禁止。  
  本アプリは利用しない方針。
- **データプライバシー**：収集は最小限（ユーザーID・設定値）。国外リージョン保管を明記。匿名運用を基本。

---

## 10. 将来的拡張
- **履歴/レポート**：ロック履歴、解除試行、電源再起動等のイベントログ収集と可視化。
- **通知**：開始前リマインド、終了直前の残り時間通知（Android 13+ の正確アラーム権限に対応）。
- **サブスク**：広告非表示、詳細統計、クラウドバックアップ等の解放。

---

## 11. バージョン履歴
| バージョン | 変更内容 | 日付 |
|-----------|----------|------|
| v1.1 | 初版（Lock Task Mode 概要） | 2025/10/21 |
| v1.2 | Lock Task + AlarmManager 対応、法的方針追記 | 2025/10/22 |
| **v1.3** | **2タブUI / 黒×黄色テーマ / 権限導入（未許可は毎回表示） / 設定内ログイン導線 / ロック中カウント表示** を正式化 | **2025/11/01** |
