# スマホ依存防止アプリ 要件定義書（v1.2）

---

## 1. 概要
本アプリは、スマホ依存症の克服を目的とした **「完全ロック型スマホ制御アプリ」** である。  
ユーザーが設定した一定時間、スマートフォンの操作を完全に制限し、  
通話およびSMSなどの最低限の機能以外を使用できなくする。  

本アプリは Android の公式機能である **Lock Task Mode（全画面固定モード）** を利用し、  
非公式APIやAccessibility権限を使用しない、安全で合法的な制御を実現する。

---

## 2. システム構成

| コンポーネント | 技術スタック |
|----------------|--------------|
| フロントエンド | Kotlin（Jetpack Compose） |
| バックエンド   | Supabase（Auth, Realtime, Storage） |
| 認証方式       | Supabase Auth（Emailリンク or Googleログイン） |
| タイマー制御   | AlarmManager（正確なロック時間制御用） |
| デプロイ環境   | Google Play（β版リリース想定） |

---

## 3. 機能要件

### 3.1 ロック設定機能
- ユーザーは **1分〜72時間** の範囲でロック時間を設定できる。  
- 時間選択UIは **スライダー形式** または **縦向きダイヤル形式**（Android標準のTimePicker風）を採用。  
- 「ロック開始」ボタンを押すと、  
  「本当にロックしてもよろしいですか？」という確認ダイアログを表示。  
- ロック開始後は、確認なしで解除することはできない。  
- ロック開始時、**AlarmManager** により解除時刻をスケジュール登録する。

### 3.2 ロックモード（全画面固定モード）
- Android公式の **Lock Task Mode** を利用。  
- ロック中は以下の状態を維持：  
  - ホームボタンを押してもアプリが終了しない  
  - 通知バーをスワイプしても通知が開かない（機種によって一部例外あり）  
  - 設定・コントロールセンターを開いてもアプリが前面表示を維持  
- 使用可能な機能は以下のみ：  
  - 電話の発信・着信  
  - SMSの送受信  
- **他アプリの上に重ねて表示する権限（SYSTEM_ALERT_WINDOW）** は使用しない。  

### 3.3 ロック解除
- **AlarmManager** により設定時間経過後、自動でLock Task Modeを終了。  
- 強制解除機能は原則として提供しない（開発者モードでのみ手動解除可能）。  
- 電源再起動時にはLock Task Modeは解除される（安全設計）。  

### 3.4 データ記録（Supabase）
- 現時点では以下のデータのみをSupabaseに記録：  
  - ユーザーID（匿名IDでも可）  
  - ロック時間設定値（例：180分など）  
- **ロック開始・解除時刻** はローカルで管理（オンライン同期不要）。  
  理由：オフライン利用が想定され、サーバー側で時刻管理する必要性が低いため。  

---

## 4. 将来的拡張

### 4.1 ロック中イベントログ
将来的には以下のイベントをSupabaseへ送信・保存可能にする：  
- 解除試行回数（例：「設定アプリを開こうとした」など）  
- 電源再起動イベント  
- タスクキル操作  

**目的：**  
ユーザーがどのタイミングでスマホを使いたくなるかを可視化し、  
依存傾向分析・行動パターンの最適化に活用する。  

### 4.2 通知・リマインダー拡張
- AlarmManagerと連携し、  
  - ロック開始前のリマインダー通知  
  - ロック終了直前の残り時間通知  
  を実装予定。  
- Android 13以降の「SCHEDULE_EXACT_ALARM」権限を明示的に要求し、  
  システムに許可を求める設計とする。

---

## 5. 非機能要件

| 項目 | 内容 |
|------|------|
| 対応OS | Android 11以降 |
| オフライン対応 | 完全ローカル動作（Supabase同期は任意） |
| セキュリティ | Supabase Authによるセキュア認証 |
| 権限設計 | Accessibility・UsageStats・Overlay権限は不使用（Lock Task Mode＋AlarmManagerのみ） |
| UI設計 | シンプル・直感的・タッチ操作中心（Material 3準拠） |
| ストレージ | Supabase Storage（将来的なバックアップ用途） |
| 通信 | HTTPS通信必須（Supabase API） |

---

## 6. 法的・規約上の考慮

- **Google Playポリシー遵守方針**  
  - Accessibility Serviceは使用しない（非支援目的利用は規約違反のため）  
  - Lock Task ModeはAndroid公式機能として合法的に使用可  
  - SYSTEM_ALERT_WINDOW等のUI妨害系権限は不使用  
- **プライバシーポリシー**  
  - Supabase経由で収集するデータは「ユーザーID・ロック設定値」のみ  
  - 国外（米国リージョン）でのデータ保管を明記  
  - 個人を特定しない匿名運用を基本とする  

---

## 7. 今後の課題
- Lock Task Modeの機種依存動作の検証（Pixel, Galaxy, Xperia等でPoC実施）  
- AlarmManagerの省電力モード下での精度検証  
- Supabase無料枠でのスケーラビリティ確認  
- 緊急解除UIや「安全警告ダイアログ」の導入  
- UX改善（ロック中の残り時間表示、解除時アニメーションなど）

---

## バージョン履歴
| バージョン | 更新内容 | 日付 |
|-------------|------------|------|
| v1.1 | 初版（Lock Task Mode 概要） | 2025/10/21 |
| **v1.2** | Lock Task Mode＋AlarmManager対応、法的方針追記、不要権限削除 | **2025/10/22** |
